//(c) Copyright 2015 Pivotal Software, Inc. All Rights Reserved.
'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var express = require('express');
var mime = require('mime');
var path = require('path');
var favicon = require('serve-favicon');

function log(message) {
  try {
    var _require = require('gulp-util');

    var _log = _require.log;

    _log(message);
  } catch (e) {
    console.log(message);
  }
}

function renderFile(res, files, pathname, whenReady) {
  whenReady().then(function () {
    var contents = void 0;
    pathname = pathname.replace('%20', ' ');
    if (pathname && (contents = files[pathname])) {
      res.status(200).type(mime.lookup(pathname)).send(contents.toString());
      return;
    }
    res.status(404).send('File not Found');
  }, function () {
    renderFile(res, files, pathname, whenReady);
  });
}

var Server = {
  createServer: function createServer(files) {
    var options = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    var app = express();

    app.use(favicon(path.resolve(__dirname, '..', 'public', 'jasmine_favicon.png')));

    app.get('/', function (req, res) {
      var _options$whenReady = options.whenReady;
      var whenReady = _options$whenReady === undefined ? function () {
        return _promise2.default.resolve();
      } : _options$whenReady;

      renderFile(res, files, 'specRunner.html', whenReady);
    });

    app.get('*', function (req, res) {
      var _options$whenReady2 = options.whenReady;
      var whenReady = _options$whenReady2 === undefined ? function () {
        return _promise2.default.resolve();
      } : _options$whenReady2;

      var filePath = req.path.replace(/^\//, '');
      var pathname = path.normalize(filePath);
      renderFile(res, files, pathname, whenReady);
    });

    return app;
  },
  listen: function listen(port, files) {
    var options = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

    return new _promise2.default(function (resolve) {
      var server = Server.createServer(files, options).listen(port, function () {
        log('Jasmine server listening on port ' + port);
        resolve({ server: server, port: port });
      });
    });
  }
};

module.exports = Server;