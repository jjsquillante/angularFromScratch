'use strict';

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var isStream = require('is-stream');
var through = require('through');

function flatMap(callback) {
  var streams = [];
  var index = 0;
  return through(function (data) {
    var _this = this;

    callback(data, function (err, data) {
      if (err) return _this.emit('error', err);
      if (Array.isArray(data)) return data.forEach(_this.queue);
      if (isStream(data)) return streams.push(new _promise2.default(function (resolve) {
        return data.pipe(through(_this.queue, function () {
          return resolve();
        }));
      }));
      _this.queue(data);
    }, index++);
  }, function () {
    var _this2 = this;

    _promise2.default.all(streams).then(function () {
      return _this2.queue(null);
    });
  });
}

module.exports = flatMap;